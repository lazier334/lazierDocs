var indexRequest=null;const mdFlag='${MD_TEXT}';const CACHE_NAME='lazier-docs-cache-v1';const handlerSuffixMap={'.md':processMdResponse};const encoder=new TextEncoder();self.addEventListener('install',(event)=>{console.log('Service Worker 安装完成');self.skipWaiting()});self.addEventListener('activate',(event)=>{console.log('Service Worker 激活完成');event.waitUntil(self.clients.claim())});self.addEventListener('fetch',(event)=>{const request=event.request;const url=new URL(request.url);if(url.pathname.endsWith('/clearSWCache')){console.log('清理缓存');event.respondWith(clearCacheHandler(event));return}if(url.pathname.endsWith('.md')){event.respondWith(cacheFirstHandler(event,'.md'));return}if(url.pathname.endsWith('/index.html')){indexRequest=event.request;event.respondWith(cacheFirstHandler(event));return}event.respondWith(cacheFirstHandler(event))});async function cacheFirstHandler(event,handlerSuffix){const request=event.request;const handler=handlerSuffixMap[handlerSuffix]||(r=>r);try{const cachedResponse=await caches.match(request);if(cachedResponse){return handler(cachedResponse.clone())}const networkResponse=await fetch(request);if(networkResponse&&networkResponse.status===200){const responseToCache=networkResponse.clone();const cache=await caches.open(CACHE_NAME);cache.put(request,responseToCache).catch(err=>{console.warn('缓存写入失败:',err)})}return handler(networkResponse.clone())}catch(error){const cachedResponse=await caches.match(request);if(cachedResponse){return handler(cachedResponse.clone())}return new Response('网络不可用，且无缓存内容',{status:503,statusText:'Service Unavailable',headers:new Headers({'Content-Type':'text/plain'})})}}async function clearCacheHandler(event){try{const cacheNames=await caches.keys();await Promise.all(cacheNames.map(cacheName=>caches.delete(cacheName)));console.log('所有缓存已清理完成');return new Response(JSON.stringify({success:true,message:'所有缓存已清理完成'}),{status:200,headers:{'Content-Type':'application/json'}})}catch(error){console.error('清理缓存时出错:',error);return new Response(JSON.stringify({success:false,message:'清理缓存失败: '+error.message}),{status:500,headers:{'Content-Type':'application/json'}})}}async function processMdResponse(response){try{const indexResponse=await caches.match(indexRequest);if(!indexResponse){throw new Error('暂无首页数据');}const idnexText=await indexResponse.clone().text();const mdText=await response.text();const newMdContent=idnexText.replaceAll(mdFlag,encoder.encode(mdText));const modifiedResponse=new Response(newMdContent,{status:response.status,statusText:response.statusText,headers:new Headers({'Content-Type':'text/html; charset=utf-8','Content-Length':newMdContent.length.toString()})});return modifiedResponse}catch(error){console.error('处理.md文件内容时出错:',error);return response}}