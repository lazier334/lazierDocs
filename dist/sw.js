const swUrl=new URL(self.location.href).href.split('?').shift();const indexRequest=new Request(swUrl.replace('sw.js','index.html'));const mdFlag='${MD_TEXT}';const CACHE_NAME='lazier-docs-cache-v1';const handlerSuffixMap={'.md':processMdResponse};var cacheFiles={'':null,'index.html':null,'lazierDocs.js':null,'sw.js':null,};const SWAPI={'clearSWCache':warpApi(clearCacheHandler,'清理缓存失败!'),'updateCacheFiles':warpApi(updateCacheFiles),};const encoder=new TextEncoder();self.addEventListener('install',(event)=>{console.log('Service Worker 安装完成');cacheResources();self.skipWaiting()});self.addEventListener('activate',(event)=>{console.log('Service Worker 激活完成');event.waitUntil(self.clients.claim())});self.addEventListener('fetch',(event)=>{const request=event.request;const url=new URL(request.url);let apiArr=url.pathname.split('/SWAPI/');if(1<apiArr.length){apiArr.shift();event.respondWith(SWAPI[apiArr.join('/SWAPI/')](event));return}if(url.pathname.endsWith('.md')){event.respondWith(cacheFirstHandler(event,'.md'));return}event.respondWith(cacheFirstHandler(event))});async function cacheFirstHandler(event,handlerSuffix){const request=event.request;const handler=handlerSuffixMap[handlerSuffix]||(r=>r.clone());try{let cachedResponse=null;const apiSuffix=new URL(request.url).pathname.split('/').pop();let cachePathSuffixFlag=apiSuffix in cacheFiles;if(cachePathSuffixFlag){cachedResponse=cacheFiles[apiSuffix];if(!cachedResponse){await cacheResources();cachedResponse=cacheFiles[apiSuffix]}if(!cachedResponse){console.error('找不到缓存! 文件名:',apiSuffix)}}if(!cachedResponse)cachedResponse=await caches.match(request);if(cachedResponse){return handler(cachedResponse)}const networkResponse=await fetch(request);if(networkResponse&&networkResponse.status===200){const cache=await caches.open(CACHE_NAME);cache.put(request,networkResponse.clone()).catch(err=>{console.warn('缓存写入失败:',err)})}return handler(networkResponse)}catch(error){console.error('异常',error);const cachedResponse=await caches.match(request);if(cachedResponse){return handler(cachedResponse.clone())}return new Response('网络不可用，且无缓存内容\n'+error.messgae+'\n'+error.stack,{status:503,statusText:'Service Unavailable',headers:new Headers({'Content-Type':'text/plain; charset=utf-8'})})}}async function cacheResources(){async function save(files){for(const file of files){let cacheResponse=await caches.match(new Request(swUrl.replace('sw.js',file)));cacheFiles[file]=cacheResponse?.clone();if(file=='index.html'){cacheFiles['']=cacheResponse?.clone()}}}return caches.open(CACHE_NAME).then(async cache=>{let files=Object.keys(cacheFiles).filter(file=>file!='');save(files);files=Object.keys(cacheFiles).filter(file=>file!=''&&!cacheFiles[file]);if(0<files.length){const urls=files.map(file=>swUrl.replace('sw.js',file));return cache.addAll(urls).then(async(value)=>{save(files)})}})}async function clearCacheHandler(event){const cacheNames=await caches.keys();await Promise.all(cacheNames.map(cacheName=>caches.delete(cacheName)));console.log('所有缓存已清理完成');cacheResources();return'所有缓存已清理完成'}function warpApi(fun,errMsg){return async function(...args){try{return new Response(JSON.stringify({success:true,message:await fun(...args)}),{status:200,headers:{'Content-Type':'application/json; charset=utf-8'}})}catch(error){console.error('swapi操作时出错:',error);return new Response(JSON.stringify({success:false,message:errMsg||('swapi操作失败: '+error.message)}),{status:500,headers:{'Content-Type':'application/json; charset=utf-8'}})}}}async function processMdResponse(response){let resp=response.clone();try{const indexResponse=await caches.match(indexRequest);if(!indexResponse){throw new Error('暂无首页数据');}const idnexText=await(indexResponse.clone()).text();const mdText=await resp.text();const newMdContent=idnexText.replaceAll(mdFlag,encoder.encode(mdText));const modifiedResponse=new Response(newMdContent,{status:response.status,statusText:response.statusText,headers:new Headers({'Content-Type':'text/html; charset=utf-8','Content-Length':newMdContent.length.toString()})});return modifiedResponse}catch(error){console.error('处理.md文件内容时出错:',error);return resp}}async function updateCacheFiles(event){let data=await event.request.json();if(data){for(const k in data){data[k]=null}cacheFiles=data;await cacheResources();return'已更新缓存'}return'无效的数据'}